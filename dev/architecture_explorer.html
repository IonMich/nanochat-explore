<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nanochat Architecture Explorer</title>
    <link rel="icon" type="image/svg+xml" href="./explorer-favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-a: #f9faf7;
        --bg-b: #eef5ef;
        --bg-c: #f3efe8;
        --card: #ffffffcc;
        --card-strong: #ffffffee;
        --ink: #142218;
        --muted: #4a5b4f;
        --accent: #0d7a63;
        --accent-2: #d15a2f;
        --code-bg: #101e1d;
        --code-fg: #dff9ef;
        --code-line: #92bea7;
        --border: #d8e2db;
        --shadow: 0 14px 36px rgba(16, 40, 30, 0.12);
        --code-col-width: 760px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--ink);
        font-family: "Sora", "Segoe UI", sans-serif;
        background:
          radial-gradient(1200px 600px at 95% 5%, #f7d9bf55 0%, transparent 65%),
          radial-gradient(1000px 550px at 0% 20%, #cceadf66 0%, transparent 70%),
          linear-gradient(160deg, var(--bg-a), var(--bg-b) 45%, var(--bg-c));
      }

      .shell {
        max-width: 1240px;
        margin: 0 auto;
        padding: 28px 22px 40px;
      }

      .hero {
        padding: 14px 0 10px;
      }

      .eyebrow {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 999px;
        background: #ffffffd9;
        border: 1px solid var(--border);
        color: var(--accent);
        font-size: 12px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      h1 {
        margin: 12px 0 8px;
        font-size: clamp(1.6rem, 1.5vw + 1.2rem, 2.3rem);
        line-height: 1.1;
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
        max-width: 76ch;
      }

      .control-bar {
        position: sticky;
        top: 10px;
        z-index: 10;
        margin: 16px 0 18px;
        padding: 14px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: var(--card);
        box-shadow: var(--shadow);
        backdrop-filter: blur(8px);
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr auto;
        align-items: end;
      }

      .control-group {
        display: grid;
        gap: 8px;
      }

      .control-label {
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .search {
        width: 100%;
      }

      .search {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font: inherit;
        color: var(--ink);
        background: #fff;
      }

      .stat-pill {
        justify-self: end;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--muted);
        font-size: 12px;
      }

      .rows {
        display: grid;
        gap: 16px;
      }

      .row {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: var(--card-strong);
        box-shadow: var(--shadow);
        overflow: hidden;
        opacity: 0;
        transform: translateY(12px);
        transition: opacity 320ms ease, transform 320ms ease;
      }

      .row.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .row-head {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(100deg, #ffffff, #f4f8f5);
      }

      .row-title {
        margin: 0;
        font-size: 1rem;
      }

      .row-grid {
        display: grid;
        grid-template-columns: var(--code-col-width) minmax(0, 1fr);
        min-height: 260px;
      }

      .code-col {
        background: var(--code-bg);
        color: var(--code-fg);
        border-right: 1px solid #1f3830;
        min-width: 0;
      }

      .comment-col {
        padding: 14px 14px 16px;
        min-width: 0;
      }

      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 12px;
        border-bottom: 1px solid #23443a;
      }

      .tab {
        cursor: pointer;
        border: 1px solid #2f584b;
        background: #143128;
        color: #b7d9cb;
        border-radius: 999px;
        padding: 6px 10px;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        font-size: 11px;
      }

      .tab.active {
        border-color: #3bc49d;
        color: #e7fff5;
        background: #1b4a3d;
      }

      .snippet-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid #23443a;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        font-size: 12px;
        color: var(--code-line);
      }

      .snippet-path {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .code-wrap {
        position: relative;
      }

      pre {
        margin: 0;
        padding: 12px;
        overflow-x: auto;
        overflow-y: auto;
        max-height: 420px;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        font-size: 12px;
        line-height: 1.45;
        white-space: pre;
      }

      .fade {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 86px;
        background: linear-gradient(180deg, transparent, rgba(16, 30, 29, 0.98));
        pointer-events: none;
      }

      .expand-btn {
        position: absolute;
        right: 12px;
        bottom: 10px;
        border: 1px solid #2f584b;
        background: #17382f;
        color: #d9f7ea;
        border-radius: 8px;
        padding: 6px 10px;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        font-size: 11px;
        cursor: pointer;
      }

      .commentary {
        display: grid;
        gap: 10px;
      }

      .commentary p {
        margin: 0;
        color: #25352c;
        line-height: 1.6;
      }

      .inline-code {
        display: inline-block;
        border-radius: 6px;
        padding: 0.08rem 0.38rem;
        border: 1px solid #d2ddd5;
        background: #f4f8f5;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        font-size: 0.88em;
      }

      .refs {
        display: flex;
        flex-wrap: wrap;
        gap: 7px;
        margin-top: 8px;
      }

      .ref-chip {
        border: 1px solid #d6e0d9;
        color: #355144;
        background: #fbfefc;
        border-radius: 999px;
        padding: 5px 9px;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        font-size: 11px;
      }

      .empty {
        border: 1px dashed var(--border);
        border-radius: 14px;
        background: #ffffffa8;
        padding: 30px;
        text-align: center;
        color: var(--muted);
      }

      .error {
        border: 1px solid #e6b2a1;
        background: #fff0eb;
        color: #89381d;
        border-radius: 12px;
        padding: 12px;
      }

      @media (max-width: 980px) {
        .control-bar {
          grid-template-columns: 1fr;
        }

        .stat-pill {
          justify-self: start;
        }

        .row-grid {
          grid-template-columns: 1fr;
        }

        .code-col {
          border-right: none;
          border-bottom: 1px solid #1f3830;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      import React from "https://esm.sh/react@18.3.1";
      import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";
      import htm from "https://esm.sh/htm@3.1.1";

      const html = htm.bind(React.createElement);
      const DATA_URL = "./architecture_blocks.ui.json";
      const DEFAULT_COLLAPSE_LINES = 24;

      function refLabel(ref) {
        if (ref.start === ref.end) return `${ref.path}:${ref.start}`;
        return `${ref.path}:${ref.start}-${ref.end}`;
      }

      function InlineCodeText({ text }) {
        const pieces = text.split(/(`[^`]+`)/g);
        return html`
          <span>
            ${pieces.map((piece, i) => {
              if (piece.startsWith("`") && piece.endsWith("`")) {
                return html`<code key=${i} className="inline-code">${piece.slice(1, -1)}</code>`;
              }
              return html`<span key=${i}>${piece}</span>`;
            })}
          </span>
        `;
      }

      function SnippetPanel({ snippet, maxLines }) {
        const [expanded, setExpanded] = React.useState(false);
        React.useEffect(() => setExpanded(false), [snippet.path, snippet.start, snippet.end, maxLines]);

        const lines = React.useMemo(() => snippet.code.split("\n"), [snippet.code]);
        const isLong = lines.length > maxLines;
        const visibleLines = isLong && !expanded ? lines.slice(0, maxLines) : lines;

        return html`
          <div>
            <div className="snippet-meta">
              <div className="snippet-path">${snippet.path}:${snippet.start}-${snippet.end}</div>
              <div>${snippet.line_count} lines</div>
            </div>
            <div className="code-wrap">
              <pre><code>${visibleLines.join("\n")}</code></pre>
              ${isLong && !expanded && html`<div className="fade"></div>`}
              ${isLong &&
              html`
                <button className="expand-btn" onClick=${() => setExpanded((v) => !v)}>
                  ${expanded ? "Collapse" : `Expand (${snippet.line_count - maxLines} more lines)`}
                </button>
              `}
            </div>
          </div>
        `;
      }

      function ArchitectureRow({ block, index, maxLines }) {
        const [activeSnippet, setActiveSnippet] = React.useState(0);
        const [visible, setVisible] = React.useState(false);
        const rowRef = React.useRef(null);

        React.useEffect(() => {
          const node = rowRef.current;
          if (!node) return;
          const observer = new IntersectionObserver(
            (entries) => {
              for (const entry of entries) {
                if (entry.isIntersecting) {
                  setVisible(true);
                  observer.disconnect();
                  break;
                }
              }
            },
            { threshold: 0.12 }
          );
          observer.observe(node);
          return () => observer.disconnect();
        }, []);

        const current = block.snippets[activeSnippet];

        return html`
          <section ref=${rowRef} className=${`row ${visible ? "visible" : ""}`}>
            <header className="row-head">
              <h2 className="row-title">${index + 1}. ${block.title}</h2>
            </header>
            <div className="row-grid">
              <div className="code-col">
                <div className="tabs">
                  ${block.snippets.map(
                    (snippet, i) => html`
                      <button
                        key=${snippet.label}
                        className=${`tab ${i === activeSnippet ? "active" : ""}`}
                        onClick=${() => setActiveSnippet(i)}
                      >
                        ${snippet.label}
                      </button>
                    `
                  )}
                </div>
                <${SnippetPanel} snippet=${current} maxLines=${maxLines} />
              </div>
              <aside className="comment-col">
                <div className="commentary">
                  ${block.commentary.map((paragraph, i) => html`<p key=${i}><${InlineCodeText} text=${paragraph} /></p>`)}
                </div>
                <div className="refs">
                  ${block.references.map((ref, i) => html`<span key=${i} className="ref-chip">${refLabel(ref)}</span>`)}
                </div>
              </aside>
            </div>
          </section>
        `;
      }

      function App() {
        const [data, setData] = React.useState(null);
        const [error, setError] = React.useState("");
        const [query, setQuery] = React.useState("");

        React.useEffect(() => {
          fetch(DATA_URL)
            .then((r) => {
              if (!r.ok) throw new Error(`Failed to load ${DATA_URL}: HTTP ${r.status}`);
              return r.json();
            })
            .then((payload) => setData(payload))
            .catch((err) => setError(String(err)));
        }, []);

        const filteredBlocks = React.useMemo(() => {
          if (!data) return [];
          const q = query.trim().toLowerCase();
          if (!q) return data.blocks;
          return data.blocks.filter((block) => {
            if (block.title.toLowerCase().includes(q)) return true;
            if (block.commentary.some((t) => t.toLowerCase().includes(q))) return true;
            if (block.references.some((r) => refLabel(r).toLowerCase().includes(q))) return true;
            if (block.snippets.some((s) => s.label.toLowerCase().includes(q))) return true;
            return false;
          });
        }, [data, query]);

        return html`
          <main className="shell">
            <section className="hero">
              <span className="eyebrow">Architecture UI</span>
              <h1>${data ? data.title : "Loading architecture data..."}</h1>
              ${data && html`<p className="subtitle">${data.subtitle}</p>`}
            </section>

            <section className="control-bar">
              <label className="control-group">
                <span className="control-label">Filter blocks</span>
                <input
                  className="search"
                  type="text"
                  placeholder="Search by title, comments, snippets, or references"
                  value=${query}
                  onInput=${(e) => setQuery(e.target.value)}
                />
              </label>
              ${data &&
              html`<div className="stat-pill">
                ${filteredBlocks.length} / ${data.blocks.length} blocks
              </div>`}
            </section>

            ${error && html`<div className="error">${error}</div>`}

            ${!error &&
            data &&
            html`
              <section className="rows">
                ${filteredBlocks.length === 0 &&
                html`<div className="empty">No blocks match this filter.</div>`}
                ${filteredBlocks.map(
                  (block, i) =>
                    html`<${ArchitectureRow}
                      key=${block.id}
                      block=${block}
                      index=${i}
                      maxLines=${DEFAULT_COLLAPSE_LINES}
                    />`
                )}
              </section>
            `}
          </main>
        `;
      }

      createRoot(document.getElementById("root")).render(html`<${App} />`);
    </script>
  </body>
</html>
